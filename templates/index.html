<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta charset="UTF-8">
    <title>Upload hoặc Paste Nhiều Ảnh</title>
    <style>
        body {
            font-family: Arial;
            margin: 40px auto;
            max-width: 1000px;
        }

        form {
            text-align: center;
            margin-bottom: 30px;
        }

        .top-bar {
            text-align: center;
            margin-bottom: 20px;
        }

        #upload-btn {
            padding: 10px 16px;
            font-size: 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        #generate-btn {
            padding: 10px 16px;
            font-size: 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .image-item {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
        }

        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px;
            cursor: pointer;
        }

        .url-block {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .url-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .url-text {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .copy-btn, .delete-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button i {
            font-size: 14px;
        }

        .copy-btn {
            background: #3b82f6;
        }

        .delete-btn {
            background: red;
        }

        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .zoom-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 6px;
            box-shadow: 0 0 20px #fff;
        }

        .zoom-close {
            position: fixed;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }

        .selected {
            border: 2px solid #3b82f6;
            background-color: #e0f0ff;
        }

        .selected {
            border: 2px solid #3b82f6;
            background-color: #e0f0ff;
        }

        .checkbox {
            appearance: none;
            width: 26px;
            height: 26px;
            border: 2px solid #888;
            border-radius: 4px;
            display: inline-block;
            position: relative;
            background: white;
            cursor: pointer;
        }

        .checkbox:checked::after {
            content: '\2714';
            position: absolute;
            top: -2px;
            left: 5px;
            font-size: 18px;
            color: #10b981;
        }

        button i {
            font-size: 14px;
            vertical-align: middle;
        }

        .desc-edit-input {
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h2 style="text-align:center">Upload một hoặc nhiều ảnh</h2>

<form id="upload-form" method="POST" enctype="multipart/form-data">
    <input type="file" id="file-input" name="images" multiple accept="image/*">
    <br><br>
    <h2>Hoặc nhấn Ctrl + V để paste một hoặc nhiều ảnh</h2>
    <div class="top-bar">
        <button id="upload-btn" type="submit">Tải ảnh lên</button>
    </div>
</form>

<div class="preview-container" id="preview-container" style="text-align: center;"></div>

{% if image_urls %}
    <h3>Danh sách ảnh đã lưu:</h3>
    <div class="top-bar">
        <button id="generate-btn" onclick="generateTestScenario()">Generate TestScenario</button>
    </div>
    <div class="grid" id="imageGrid">
        {% for img in image_urls %}
            <label class="image-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img class="thumbnail" src="{{ img.url }}"
                         onclick="showZoom('{{ img.url }}'); event.stopPropagation();">
                    <div class="url-block" style="flex-grow: 1;">
                        <div class="url-row" style="margin-bottom: 6px;">
                            <input type="text" class="url-text" value="{{ request.url_root }}{{ img.url[1:] }}"
                                   readonly>
                            <button class="copy-btn" onclick="copyToClipboard(this); event.stopPropagation();">Copy
                            </button>
                            <button class="delete-btn" onclick="deleteImage('{{ img.url }}'); event.stopPropagation();">
                                X
                            </button>
                        </div>

                        <!-- Phần mô tả nằm dưới URL, cùng hàng -->
                        <div class="url-row" style="align-items: center; gap: 8px;">
                            <span class="desc-text" style="font-size: 14px; color: #333;">{{ img.description }}</span>
                            <input type="text" class="desc-edit-input" value="{{ img.description }}"
                                   style="display:none; flex: 1; padding: 4px;">
                            <button class="copy-btn" onclick="toggleEdit(this)" title="Sửa mô tả">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="delete-btn" style="background: #10b981;"
                                    onclick="saveDescription(this, '{{ img.url.split('/')[-1] }}')" title="Lưu mô tả">
                                <i class="fa-solid fa-floppy-disk"></i>
                            </button>
                        </div>
                    </div>

                    <input type="checkbox" class="checkbox" value="{{ request.url_root }}{{ img.url[1:] }}"
                           onchange="this.closest('label').classList.toggle('selected', this.checked)">
                </div>

                {#                <!-- Hiển thị mô tả -->#}
                {#                <div style="margin-top: 8px; width: 100%;">#}
                {#                    <span class="desc-text" style="font-size: 14px; color: #333;">{{ img.description }}</span>#}
                {#                    <input type="text" class="desc-edit-input" value="{{ img.description }}"#}
                {#                           style="display:none; width: 80%; padding: 4px; margin-top: 5px;">#}
                {#                    <div style="margin-top: 4px;">#}
                {#                        <button class="copy-btn" onclick="toggleEdit(this)" title="Sửa mô tả">#}
                {#                            <i class="fa-solid fa-pen"></i>#}
                {#                        </button>#}
                {#                        <button class="delete-btn" style="background: #10b981;"#}
                {#                                onclick="saveDescription(this, '{{ img.url.split('/')[-1] }}')" title="Lưu mô tả">#}
                {#                            <i class="fa-solid fa-floppy-disk"></i>#}
                {#                        </button>#}
                {#                    </div>#}
                {#                </div>#}
            </label>

        {% endfor %}
    </div>
{% endif %}

<!-- ZOOM -->
<div class="zoom-overlay" id="zoomOverlay" onclick="hideZoom()">
    <span class="zoom-close" onclick="hideZoom()">×</span>
    <img id="zoomImage" src="">
</div>

<form id="scenario-form" method="POST" action="/generate" target="_self" style="display: none;">
    <input type="hidden" name="urls" id="scenario-urls">
</form>

<script>
    let filesToUpload = [];
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');
    const form = document.getElementById('upload-form');

    // Preview
    function addPreviewImage(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'inline-block';
            wrapper.style.margin = '5px';
            wrapper.style.textAlign = 'center';

            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            wrapper.appendChild(img);

            const inputDesc = document.createElement('input');
            inputDesc.type = 'text';
            inputDesc.placeholder = 'Mô tả ảnh';
            inputDesc.className = 'image-desc-input';
            inputDesc.style.marginTop = '5px';
            inputDesc.style.width = '100px';
            wrapper.appendChild(inputDesc);

            previewContainer.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
    }

    fileInput.addEventListener('change', (e) => {
        const selected = [...e.target.files];
        filesToUpload.push(...selected);
        selected.forEach(addPreviewImage);
    });

    document.addEventListener('paste', function (event) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.startsWith("image")) {
                const blob = item.getAsFile();
                const file = new File([blob], `clipboard_${Date.now()}.png`, {type: blob.type});
                filesToUpload.push(file);
                addPreviewImage(file);
            }
        }
    });

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (filesToUpload.length === 0) {
            alert("Vui lòng chọn hoặc paste ảnh trước khi upload.");
            return;
        }

        const formData = new FormData();
        const descInputs = document.querySelectorAll('.image-desc-input');

        filesToUpload.forEach((file, index) => {
            formData.append("images", file, file.name || `blob_${index}.png`);
            formData.append("descriptions", descInputs[index]?.value || "");
        });

        fetch("/", {
            method: "POST",
            body: formData
        }).then(() => {
            filesToUpload = [];
            previewContainer.innerHTML = '';
            location.reload();
        });
    });

    function deleteImage(imageUrl) {
        const filename = imageUrl.split('/').pop();
        fetch(`/delete?filename=${filename}`, {
            method: 'DELETE'
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert("Lỗi khi xóa ảnh: " + data.error);
            }
        });
    }

    function showZoom(src) {
        const overlay = document.getElementById('zoomOverlay');
        document.getElementById('zoomImage').src = src;
        overlay.style.display = 'flex';
    }

    function hideZoom() {
        const overlay = document.getElementById('zoomOverlay');
        overlay.style.display = 'none';
        document.getElementById('zoomImage').src = '';
    }

    function copyToClipboard(button) {
        const input = button.parentElement.querySelector('.url-text');
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        button.innerText = 'Copied!';
        setTimeout(() => {
            button.innerText = 'Copy';
        }, 1500);
    }

    function generateTestScenario() {
        const checked = document.querySelectorAll('.checkbox:checked');
        const urls = Array.from(checked).map(cb => cb.value);
        if (urls.length === 0) {
            alert("Bạn cần chọn ít nhất một ảnh.");
            return;
        }
        document.getElementById('scenario-urls').value = JSON.stringify(urls);
        document.getElementById('scenario-form').submit();
    }

    // Ngăn auto re-submit
    window.addEventListener("load", function () {
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    });

    function toggleEdit(button) {
        const label = button.closest('label');
        const span = label.querySelector('.desc-text');
        const input = label.querySelector('.desc-edit-input');

        const isEditing = input.style.display === 'inline-block';
        if (isEditing) {
            input.style.display = 'none';
            span.style.display = 'inline';
        } else {
            input.style.display = 'inline-block';
            span.style.display = 'none';
            input.focus();
        }
    }

    function saveDescription(button, filename) {
        const label = button.closest('label');
        const input = label.querySelector('.desc-edit-input');
        const span = label.querySelector('.desc-text');

        const newDesc = input.value;

        fetch('/update-description', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({filename, description: newDesc})
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                span.innerText = newDesc;
                input.style.display = 'none';
                span.style.display = 'inline';
            } else {
                alert("Không thể lưu mô tả: " + data.error);
            }
        });
    }

</script>
</body>
</html>
